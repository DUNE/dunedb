kind: Template
apiVersion: v1
metadata:
  name: deploymentConfig-sietch-app
objects:

  - kind: DeploymentConfig
    apiVersion: v1
    metadata:
      name: sietch-app-${DEPLOYMENT}
      labels:
        app: sietch-app-${DEPLOYMENT}
      namespace: sietch
    spec:
      replicas: 1
      selector:
        app: sietch-app-${DEPLOYMENT}
        deploymentconfig: sietch-app-${DEPLOYMENT}
      template: 
        metadata:
            labels:
              app: sietch-app-${DEPLOYMENT}
              deploymentconfig: sietch-app-${DEPLOYMENT}

        spec:
          containers:
            - image: >-
                docker-registry.default.svc:5000/sietch/sietch-app@sha256:b102f4d14182a86cde0803b5ef324a0839af53a69074444cf6a110c60e53c4bb
              imagePullPolicy: Always
              name: sietch-app-${RELEASE_BRANCH}
              ports: 
                - containerPort: 12313
                  protocol: TCP
              livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /
                    port: 12313
                    scheme: HTTP
                  initialDelaySeconds: 5
                  periodSeconds: 10
                  successThreshold: 1
                  timeoutSeconds: 1
              readinessProbe:
                failureThreshold: 3
                httpGet:
                  path: /
                  port: 12313
                  scheme: HTTP
                initialDelaySeconds: 5
                periodSeconds: 10
                successThreshold: 1
                timeoutSeconds: 1
              volumeMounts:
                - mountPath: /etc/sietch.d/mongodb-config
                  name: volume-mongod-cfg
                  readOnly: true
                - mountPath: /etc/sietch.d/main-config
                  name: volume-main-cfg
                - mountPath: /persistent
                  name: volume-persistent
          volumes:
            - name: volume-mongod-cfg
              secret:
                defaultMode: 420
                secretName: mongodb-config
            - name: volume-main-cfg
              secret:
                defaultMode: 420
                secretName: ${DEPLOYMENT}-config
            - name: volume-persistent
              persistentVolumeClaim:
                claimName: sietch-persistent



      triggers:
      - type: ConfigChange 
      - imageChangeParams:
          automatic: true
          containerNames:
            - sietch-app-${DEPLOYMENT}
          from:
            kind: ImageStreamTag
            namespace: sietch
            name: sietch-app:${RELEASE_BRANCH}
        type: ImageChange  
      strategy:
        type: Rolling  

  - kind: Service
    apiVersion: v1
    metadata:
      labels:
        app: sietch-app-${DEPLOYMENT}
      name: sietch-app-${DEPLOYMENT}
      namespace: sietch
    spec:
        ports:
          - name: 12313-tcp
            port: 12313
            protocol: TCP
            targetPort: 12313
        selector:
          deploymentconfig: sietch-app-${DEPLOYMENT}
  - kind: Route
    apiVersion: v1
    metadata:
      labels:
        app: sietch-app-${DEPLOYMENT}
      name: ${DEPLOYMENT}-route
      namespace: sietch
    spec:
      host: ${URL}
      port:
        targetPort: 12313-tcp
      tls:
        insecureEdgeTerminationPolicy: Allow
        termination: edge
      to:
        kind: Service
        name: sietch-app-${DEPLOYMENT}
        weight: 100
      wildcardPolicy: None


parameters:
  - name: RELEASE_BRANCH
    displayName: Which branch of the github directory I'm building from.
    value: master
    require: true

  - name: DEPLOYMENT
    displayName: production, test, or dev
    value: dev
    require: true

  - name: URL
    displayName: Typically apa.dunedb.org or variants.
    require: true
