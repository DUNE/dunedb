
mixin dateFormat(date)
    span.date(data-date=date)=moment(date).format('MMMM Do YYYY, h:mm:ss a')

mixin dateFormatAndAgo(date)
    span.date(data-date=date)=moment(date).format('MMMM Do YYYY, h:mm:ss a')
      =" ("+moment(date).fromNow()+")"

mixin find-a-component
    script(type='text/javascript' src='js/search')
    form#component-full-text-search(method="get",action='/component-search')

        label Full Text Search (doesn't work yet)
        input(name='searchterms', placeholder="Full text search for component")

mixin component-list(list)
    each dummy,type in list
        ul.component-list="type: "+type
            each val,index in list[type]
                li 
                    a(href='/'+val.componentUuid)=val.name

mixin NewWorkflowForm
  a.NewWorkflowForm.btn.btn-outline-primary(href='#', data-toggle="modal" data-target="#NewWorkflowFormModal") Create New Workflow Form
  #NewWorkflowFormModal.modal.fade(tabindex='-1' role='dialog' aria-labelledby='NewWorkflowFormLabel' aria-hidden='true')
    .modal-dialog(role="document")
      .modal-content
        .modal-header
          h5#NewWorkflowFormLabel.modal-title New Workflow Form
          button.close(type="button",data-dismiss="modal",aria-label="Close")
            span(aria-hidden=true) &times;
        .modal-body
          div
            | Enter the new form ID.
            br
            | This ID should have only underscores and alphanumerics.
            br
            | The human-readable name will be set on the next page.
            input.NewWorkflowFormModalName.form-control(type="text")
        .modal-footer
          button.btn.btn-secondary(type="button", data-dismiss="modal") Close
          button.btn.btn-primary.NewWorkflowFormCreateButton(type="button") Create
  script.
    $('button.NewWorkflowFormCreateButton').click(function(){
      window.location.href="/NewWorkflowForm/"+ $('button.NewWorkflowFormCreateButton').parents('.modal-content').find('input').val();
    })
    $('input.NewWorkflowFormModalName').on("keyup",function(e){
      if(e.key=="Enter") {
          window.location.href="/NewWorkflowForm/"+ $(this).val();
        }
    })

mixin uuid_autocomplete
    select.form-control.component-uuid-autocomplete.go-to-component(autocomplete="off" placeholder='type to search...')

block pugscripts
  - function isAuthenticated() { return !!(user); }
  - function user_email(aUser) { if (isAuthenticated()) return ((aUser.emails||[])[0]||{}).value || "";  else return "&lt;log in to see&gt;" };
  - function user_shortname(aUser) { if (isAuthenticated()) return aUser.displayName || user_email(aUser); else return "&lt;log in to see&gt;" };

mixin short_user(aUser)
  if (!user)
    span &lt;log in to see&gt;
  else
    a(href='mailto:'+user_email(user))=user.displayName||user_email(user)
    
mixin createdFrom(created_from)
     if(created_from && created_from.processRecordId)
        div.createdFrom.alert.alert-info
          span This component was created by an automated process:
          br
          a(href='/processRecord/'+created_from.processRecordId.toString()) Process Record
          br
          a(href='/'+created_from.inputRecordType+'/'+created_from.inputRecordId.toString()) Input Record

mixin qr-panel(text,desc)
  div.qr&attributes(attributes)
    .qr-label.qr-label-top
      div=text
      div=desc
    .qr-label.qr-label-left
      div=text
      div=desc
    .qr-label.qr-label-right
      div=text
      div=desc
    .qr-label.qr-label-bottom
      div=text
      div=desc
    .canvas-holder
      canvas.qr-code(data-QR-text=text,data-QR-desc=desc)      
      
mixin evaluated-course(course,interactive)
    -if(interactive!==false) interactive = true;
    table.table.table-hover
      thead
        tr
          th 
          th Type
          th Name
          th OK?
          th Completed
          th Advice

      tbody
        each step of course.evaluation
          tr
            td
              icon.small-icon(src=(step.meta||{}).icon)
            td
              = step.type
            td
              = (step.meta||{}).formName || (step.meta||{}).name || step.formId
            td
              if step.result.length>0
                i.fa.fa-check.text-success
              else
                i.fa.fa-times.text-danger
            if step.type == "component"
              td
                if step.result.length>0                  
                  a(href='/'+componentUuid).btn.btn-success=moment(component.insertion.insertDate).format("MMM D YY")
                else
                  if interactive
                    a(href='/'+componentUuid+"/edit").btn.btn--outline-danger
                      img.small-icon(src='/images/edit_icon.svg')
                      |  &nbsp; Create


            if step.type == "test"
              td
                if step.result.length>0

                  for test,index in step.result
                    a(href='/test/'+test._id).btn.btn-success=moment(test.insertion.insertDate).format("MMM D YY")
                    | &nbsp;

                  if interactive
                    a(href='/'+componentUuid+"/test/"+step.formId).btn.btn-outline-success
                          img.small-icon(src='/images/edit_icon.svg')
                          | &nbsp; Run again 
                else
                  if interactive
                    a(href='/'+componentUuid+"/test/"+step.formId).btn.btn-outline-danger
                          img.small-icon(src='/images/edit_icon.svg')
                          | &nbsp; Run

            if step.type == "job"
              td
                if step.result.length>0

                  for job,index in step.result
                    a(href='/job/'+job.jobId).btn.btn-success=moment(job.insertion.insertDate).format("MMM D YY")
                    | &nbsp;

                  if interactive
                    a(href='/job/'+step.formId).btn.btn-outline-success
                          img.small-icon(src='/images/edit_icon.svg')
                          | &nbsp; Run again
                else
                  if interactive
                    a(href='/job/'+step.formId).btn.btn-outline-danger
                          img.small-icon(src='/images/edit_icon.svg')
                          | &nbsp; Run
            td !{step.advice}
    
    if(interactive)
      p
        a(href='/course/'+course.courseId+"/next/"+componentUuid) Next Step
      p
        a(href='/course/'+course.courseId+"/next/"+componentUuid+"?firstUnfinished=1") Next Unfinished Step
    // pre
    //   =JSON.stringify(course,null,2)
