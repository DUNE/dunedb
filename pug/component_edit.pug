
extend default

mixin label-link
  a(href="/"+componentUuid+"/label") Printable labels for this component

block vars
  - var page_title=(component||{}).name || componentUuid;

block extrascripts
  script(type='text/javascript').
    var componentUuid = "!{componentUuid}";
    // I could do this by API query of the server, but this works for now.
    var schema=!{JSON.stringify(schema||{})};
    var component=!{JSON.stringify(component||{})};
  


  script(type='text/javascript').

      var form = null;
      function SubmitData(submission) {
        // actually the 'submit' function
        console.log("submitting data",submission);
        var posting =  $.ajax(
          { contentType: "application/json",
            method: "post",
            url: "/json/component/"+componentUuid,
            data: JSON.stringify(submission),
            dataType: "json",
          }
        );


        //- $.post('/json/component/'+componentUuid,submission);

        posting.done(function(retval) {
          // POST operation completed but..
          if((retval.error)) {
            form.setAlert("warning",c.error);
          form.emit('error', c.error);
          } else form.setAlert(false);
          
          if(retval.component) form.submission = {data: retval.component};
          if(window.location.pathname.includes("NewComponent")) {
            // Change the URL to match th new component componentUuid, so we're now editing
            history.replaceState(null, null, component.componentUuid+'/edit');
            $('#name').html(submission.name);
          }
          console.log("success retval",retval);
          form.emit('submitDone', retval.submission);

        });
        posting.fail(function(res,statusCode,statusMsg) {
          // On failure, add a failure message
          if(res.responseText && res.responseText.length>0) form.setAlert("danger",res.responseText);
          else                                              form.setAlert("danger",statusMsg + " ("+statusCode+")");
          //- alert("posting failed");
          console.log("posting fail",res,statusCode,statusMsg);
        });

      };

    var shortuuid = window.ShortUUID();

    window.onload = async function() {
      console.log("schema",schema);

      form = await Formio.createForm(document.getElementById('builtform'),schema,
      {
      });
      form.submission = {data: component||{componentUuid: componentUuid}};
      form.on('submit',SubmitData);
      form.nosubmit = true; // Use the beforeSubmit hook.

      // Change the url to match

      DrawQRCode($('#qrcode-canvas').get(0),'http://sietch.xyz/'+componentUuid);

      

      }

  style.
    div#qr-code {
    }
    div#qr-code canvas {
      border: 8px solid green;
      border-radius: 8px;
      width:100%;
      height:auto
    }
block content
  .container
    .row
        h2#name.col-md-8=((component||{}).type)?((component||{}).type+": "+(component||{}).name):"New Component"
    .row 
      +label-link
    .row
      #builtform.col
