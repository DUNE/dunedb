extend default

block extrascripts
  style.
      .formbuilder_area { border: 5px solid red; border-radius: 10px; padding:5px;}

  script(type='text/javascript').
      //- var record=!{JSON.stringify(rec, null ,4)};
      var form_id = "!{form_id}";
      var collection = "!{collection}";
      

  block metaschema
    script(type='text/javascript').
      var builder_wizard = false

      var metaschema = {
        "components": [
        
          {
            "label": "Commit Form",
            "showValidations": false,
            "theme": "info",
            "disableOnInvalid": true,
            "tableView": false,
            "key": "submit",
            "type": "button",
            "input": true,
            "validate": {
              "unique": false,
              "multiple": false
            }
          },
          {
            "label": "form_id",
            "key": "form_id",
            "type": "hidden",
            "input": true,
            "tableView": false,
            "validate": {
              "unique": false,
              "multiple": false
            }
          },
          {
            "label": "Form Title",
            "spellcheck": true,
            "tableView": true,
            "validate": {
              "unique": false,
              "required": true,
              "multiple": false
            },
            "key": "form_title",
            "type": "textfield",
            "input": true
          },

          {
                "label": "Columns",
                "columns": [
                  {
                    "components": [
                      {
                        "label": "Version",
                        "mask": false,
                        "spellcheck": true,
                        "disabled": true,
                        "tableView": false,
                        "delimiter": false,
                        "requireDecimal": false,
                        "inputFormat": "plain",
                        "validate": {
                          "unique": false,
                          "multiple": false
                        },
                        "key": "version",
                        "type": "number",
                        "input": true,
                        "hideOnChildrenHidden": false
                      }
                    ],
                    "width": 3,
                    "offset": 0,
                    "push": 0,
                    "pull": 0
                  },
                  {
                    "components": [
                      {
                        "label": "Last Revised by",
                        "spellcheck": true,
                        "disabled": true,
                        "tableView": true,
                        "validate": {
                          "unique": false,
                          "multiple": false
                        },
                        "key": "revised_by",
                        "type": "textfield",
                        "input": true,
                        "hideOnChildrenHidden": false
                      }
                    ],
                    "width": 3,
                    "offset": 0,
                    "push": 0,
                    "pull": 0
                  },
                  {
                    "components": [
                      {
                      "label": "Revised on",
                      "disabled": true,
                      "tableView": false,
                      "validate": {
                        "unique": false,
                        "multiple": false
                      },
                      "key": "effectiveDate",
                      "type": "datetime",
                      "input": true,
                      "suffix": "<i ref=\"icon\" class=\"fa fa-calendar\" style=\"\"></i>",
                      "widget": {
                        "type": "calendar",
                        "displayInTimezone": "viewer",
                        "language": "en",
                        "useLocaleSettings": false,
                        "allowInput": true,
                        "mode": "single",
                        "enableTime": true,
                        "noCalendar": false,
                        "format": "yyyy-MM-dd hh:mm a",
                        "hourIncrement": 1,
                        "minuteIncrement": 1,
                        "time_24hr": false,
                        "minDate": null,
                        "maxDate": null
                      }
                    },
                    ],
                    "width": 3,
                    "offset": 0,
                    "push": 0,
                    "pull": 0
                  }
                ],
                "tableView": false,
                "key": "columns",
                "type": "columns",
                "input": false,
                "validate": {
                  "unique": false,
                  "multiple": false
                },
                "path": "columns"
              },

          {
            "label": "formbuilder",
            "tag": "div",
            "className": "formbuilder_area",
            "attrs": [
              {
                "attr": "",
                "value": ""
              }
            ],
            "refreshOnChange": false,
            "tableView": false,
            "key": "formbuilder",
            "type": "htmlelement",
            "input": false,
            "validate": {
              "unique": false,
              "multiple": false
            }
          },
          {
            "label": "schema",
            "key": "schema",
            "type": "hidden",
            "input": true,
            "tableView": false,
            "validate": {
              "unique": false,
              "multiple": false
            }
          },

          {
            "label": "Commit Form",
            "showValidations": false,
            "theme": "info",
            "disableOnInvalid": true,
            "tableView": false,
            "key": "submit",
            "type": "button",
            "input": true,
            "validate": {
              "unique": false,
              "multiple": false
            }
          }
        ]
      };

  block workscripts
    script.
      function updateSchemaField(schema)
      {
        $('#schema').val(JSON.stringify(schema,null,2));
        var schema_blob = new Blob([JSON.stringify(schema,null,2)],{type: 'application/JSON'});
        var schema_save_url = window.URL.createObjectURL(schema_blob);
        $('#download_schema_link').attr('href',schema_save_url);
      }
      function onBuild() {
        //- var schema_element = document.getElementById('schema');

        metaform.submission.data.schema = builder.instance.schema; // Copy it over.
        updateSchemaField(builder.instance.schema);
        console.log("onBuild",JSON.stringify(builder.instance.schema));

      };
      var gformdata;

      function schemaRecordChange(formdata) {
          console.log("schemaRecordChange",formdata);
          gformdata = formdata;
          metaform.submission.data.revised_by = ((formdata.submit||{}).user||{}).displayName;
          metaform.submission = {data: formdata};
          // If no form title, autofill with the form ID
          if(!formdata.form_title || (formdata.form_title.length==0))
            formdata.form_title = formdata.form_id;
          updateSchemaField(formdata.schema);

          builder = new Formio.FormBuilder(
              $('.formbuilder_area').get(0), // html element
              formdata.schema||{}, // starting schema
              {
                   builder: {
                      dataentry: {

                        title: 'Data entry',
                        default: true,
                        weight: 0, 
                        components: {                           
                                      textfield: true, 
                                      textarea: true, 
                                      number:true, 
                                      SpecNumberComponent: true,
                                      ArrayComponent: true, }
                      },
                      dataentryLeft: {
                        title: "Data / label left",
                        default: false,
                        weight:5,
                        components: {
                          textfield_left: { title:'Text field', icon:'align-right',schema: {type: 'textfield', labelPosition: 'left-right'} },
                          specnumber_left:{ title:'Number (w spec)', icon:'align-right', schema: {type: 'SpecNumberComponent', labelPosition: 'left-right'} },
                        }
                      },
                      enumerated: {
                        title: 'Enumerations',
                        default: false,
                        weight: 10,
                        components: { radio: true,
                                      select: true,
                                      selectboxes: true,
                                      
                                      }

                      },
                      specialized: {
                        title: 'Specialized',
                        weight: 20,
                        components: { ComponentUUID:true,
                                      url: true,
                                      datetime: true,
                                      file: {title: "File upload", icon: 'file', schema: {type: 'file', label: 'File Upload', key: 'files'}},
                                      ImageAnnotator: true,
                                      image: { title: "Image upload", icon: 'picture-o', schema: {type:'file', label: 'Picture upload', key:'picture', image: true}},
                                      CustomGeoTagComponent: true,




                        }
                      },
                      mulitple:{
                        title: 'Multiple',
                        weight: 30,
                        components: { datamap: true, 
                                     datagrid: true,
                                     editgrid: true,
                                     tree:true,
                                      }
                      },
                      layout: {
                        title: "Layout",
                        default: false,
                        weight: 40,
                        components: { 
                          //- WorkStepComponent: true,
                          htmlelement: { title:"HTML", icon:'code', weight: 1000, schema:{type: 'htmlelement'}},
                          content: true,
                          columns: true,
                          fieldset: true,
                          panel: true,
                          table: true,
                          tabs: true,
                          well:true,
                          container: true,
                          DatabaseImage: true,
                          DatabaseFile: true,
                          AnnotatedImage: true
                        }
                      },

                      misc: {
                        title: 'Little-used',
                        default: false,
                        weight: 1000,
                        components: {
                        hidden: true,
                        tags: true,
                        email: true,
                        phoneNumber: true,
                        address: true,
                        day: true,
                        time: true,
                        signature: true,
                        button: true,
                        saveDraftButton: {title: 'Save Draft button', icon: 'button', weight: 1000, schema:{type:'button', action:"saveState", state: 'draft', theme: 'secondary', key:'saveAsDraft', label:'Save Draft'}}
                        //- currency: true,
                          //- survey: true,
                        //- password: true

                        }
                      },

                      basic: false,
                      advanced: false,
                      data: false,
                      //- layout: false,
                      premium: false,

                      //- custom: {
                      //-   title: 'Custom',
                      //-   default: false,
                      //-   weight: 10,
                      //-   components: {
                      //-     ComponentUUID:true,
                      //-     CustomGeoTagComponent: true,
                      //-     ArrayComponent: true,
                      //-     SpecNumberComponent: true,
                      //-     WorkStepComponent: true,
                        
                      //-   }
                      //- }
                  }
              }
          );
          $('input#commit-schema').val(JSON.stringify(schema));
            builder.instance.ready.then(function(){
            if(builder_wizard) builder.setDisplay('wizard').then(onBuild);
            else onBuild();

            builder.instance.on('saveComponent',onBuild);
            builder.instance.on('editComponent',onBuild);
          });
      }

      function SubmitData(submission) {
        console.log("submitting data",submission);
        $.post({
            contentType: 'application/json',
            url:  "/json/"+collection+"/"+form_id,
            data: JSON.stringify(submission.data),
            success: schemaRecordChange
        }).fail(function(res,statusCode,statusMsg) {
          // On failure, add a failure message
          if(res.responseText && res.responseText.length>0) metaform.setAlert("danger",res.responseText);
          else                                              metaform.setAlert("danger",statusMsg + " ("+statusCode+")");
          //- alert("posting failed");
          console.log("posting fail",res,statusCode,statusMsg);
        });

      };


      window.onload = async function() {
        //- console.log("schema",record.schema);
        // First, modify the metaschema based on the component type list

        // Create the metaform
        metaform = await Formio.createForm(document.getElementById('metaform'),metaschema);
        console.log("metaform built",metaform);
        metaform.on('submit',SubmitData);
   
        $.get('/json/'+collection+'/'+form_id,schemaRecordChange).fail(function(){
              $('#builder').html("No such form exists.")
          });

   
        // validate on client side.
        $('#commit').on('click',function(event){
          if($('input#form_id').val().length<1) {alert("Need to enter a form ID"); return false;}
          if($('input#form_title').val().length<1) {alert("Need to enter a form title"); return false;}

          var data = $( '#metaform'  ).serialize();
          $.post({
            url: '/json/'+collection+'/'+form_id,
            data: data,
            success: schemaRecordChange
          }).fail(function(j,textStatus,errorThrown){
              $('#builder').html("something went wrong,could not post: "+textStatus);
          });
          return false;
        });

        $('#schema').change(function(){
          builder.form = JSON.parse($('#schema').val());
          metaform.submission.data.schema = builder.instance.schema; // Copy it over.

          console.log("updated schema json->builder")
          //- builder.instance.redraw();
        })

      };




block content
  h2=form_id
  div#metaform



  a#download_schema_link(download=form_id+".json", href="") Download Form Record JSON

  .panel.panel-default
  .foldable-heading.panel-heading.collapsed(data-toggle='collapse' data-target='#json-holder')
    | Schema JSON (for debugging) 
    i.chevron.fa.fa-fw
  div#json-holder.collapse
    textarea#schema.form-control(rows=20)


